name: reusableProdPuppeteer

on: 
  workflow_call:
    inputs:
      site:
        description: 'site'
        required: true
        type: string

env:
  site: ${{inputs.site}}
  MONGODB_URL: ${{secrets.MONGODB_URL}}
  GH_TOKEN: ${{secrets.GH_TOKEN}}
  GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS}}
  GOOGLE_SHEET_ID: ${{secrets.GOOGLE_SHEET_ID}}
  GOOGLE_DRIVE_FOLDER_ID: ${{secrets.GOOGLE_DRIVE_FOLDER_ID}}

jobs:
  playwright-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Cache system dependencies
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: ca-certificates fonts-liberation libappindicator3-1 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 libpango-1.0-0 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 lsb-release wget xdg-utils chromium-browser libatk1.0-0 libatk-bridge2.0-0 libdrm2 libxcb-dri3-0 libxcb-present0 libxshmfence1
        version: 1.0

    - name: Cache Puppeteer browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/puppeteer
        key: ${{ runner.os }}-puppeteer-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-puppeteer-

    - name: Install Node.js dependencies
      run: npm ci --prefer-offline --no-audit

    - name: Install Puppeteer browsers (if not cached)
      run: |
        if [ ! -d ~/.cache/puppeteer ]; then
          echo "Installing Puppeteer browsers..."
          npx puppeteer browsers install chrome
        else
          echo "Puppeteer browsers found in cache, skipping installation"
        fi

    - name: Run data aggregation
      run: node prodCrawlerPuppeteer.js

    - name: Run data upload
      run: node src/pushToGit.js
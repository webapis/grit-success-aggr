name: reusableProdPuppeteer

on: 
  workflow_call:
    inputs:
      site:
        description: 'site'
        required: true
        type: string
      sheet-data:
        description: 'Base64 encoded sheet data'
        required: false
        type: string

env:
  site: ${{inputs.site}}
  MONGODB_URL: ${{secrets.MONGODB_URL}}
  GH_TOKEN: ${{secrets.GH_TOKEN}}
  GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS}}
  GOOGLE_SHEET_ID: ${{secrets.GOOGLE_SHEET_ID}}
  GOOGLE_DRIVE_FOLDER_ID: ${{secrets.GOOGLE_DRIVE_FOLDER_ID}}

jobs:
  playwright-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Download shared sheet data
    - name: Download sheet data artifact
      uses: actions/download-artifact@v4
      with:
        name: sheet-data
      continue-on-error: true

    # Create sheet data from input if artifact download failed
    - name: Create sheet data from input
      if: inputs.sheet-data != ''
      run: |
        echo '${{ inputs.sheet-data }}' | base64 -d > sheet-data.json

    # Move sheet data to expected location
    - name: Setup cached sheet data
      run: |
        if [ -f sheet-data.json ]; then
          cp sheet-data.json siteConfig.json
          echo "Sheet data prepared for use"
          cat siteConfig.json | head -10  # Debug: show first few lines
        else
          echo "No sheet data available, will fetch from API"
        fi

    - name: Setup Node.js with caching
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Cache Puppeteer browsers
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/puppeteer
          ~/.local/share/puppeteer
          node_modules/puppeteer/.local-chromium
        key: ${{ runner.os }}-puppeteer-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-puppeteer-

    - name: Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        
    - name: Run data agr
      run: node prodCrawlerPuppeteer.js

    - name: Run data upload
      run: node src/pushToGit.js
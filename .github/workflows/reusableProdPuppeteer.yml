name: reusableProdPuppeteer

on: 
  workflow_call:
    inputs:
      site:
        description: 'Site name to crawl'
        required: true
        type: string

env:
  site: ${{inputs.site}}
  MONGODB_URL: ${{secrets.MONGODB_URL}}
  GH_TOKEN: ${{secrets.GH_TOKEN}}
  GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS}}
  GOOGLE_SHEET_ID: ${{secrets.GOOGLE_SHEET_ID}}
  GOOGLE_SHEET_ID_FOR_LOGS: ${{secrets.GOOGLE_SHEET_ID_FOR_LOGS}}
  GOOGLE_DRIVE_FOLDER_ID: ${{secrets.GOOGLE_DRIVE_FOLDER_ID}}
  GET_LOCAL_SITE_CONF: 'TRUE'

jobs:
  crawler-job:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js with caching
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Download sheet data artifact
      id: download-artifact
      uses: actions/download-artifact@v4
      with:
        name: sheet-data
        path: .
      continue-on-error: true

    - name: Setup cached sheet data
      run: |
        CACHE_STATUS="none"
        
        if [ -f sheet-data.json ]; then
          # Validate JSON structure
          if jq empty sheet-data.json 2>/dev/null; then
            cp sheet-data.json siteConfig.json
            echo "âœ… Found and validated cached sheet data"
            echo "ğŸ“Š Sheet data info:"
            echo "  Timestamp: $(cat siteConfig.json | jq -r '.timestamp // "Unknown"')"
            echo "  Rows: $(cat siteConfig.json | jq '.data | length' 2>/dev/null || echo 'Unknown')"
            echo "  Source: Artifact cache"
            CACHE_STATUS="artifact"
          else
            echo "âš ï¸  Found sheet-data.json but it's invalid JSON"
            rm -f sheet-data.json siteConfig.json
            CACHE_STATUS="invalid"
          fi
        else
          echo "â„¹ï¸  No cached data artifact found"
          
          # Check if there's already a siteConfig.json (from previous run or manual setup)
          if [ -f siteConfig.json ]; then
            if jq empty siteConfig.json 2>/dev/null; then
              echo "âœ… Found existing siteConfig.json"
              echo "  Source: Pre-existing file"
              CACHE_STATUS="existing"
            else
              echo "âš ï¸  Found siteConfig.json but it's invalid"
              rm -f siteConfig.json
              CACHE_STATUS="invalid"
            fi
          else
            CACHE_STATUS="none"
          fi
        fi
        
        case $CACHE_STATUS in
          "artifact"|"existing")
            echo "ğŸš€ Will use cached configuration data"
            ;;
          "none"|"invalid")
            echo "ğŸŒ Will fetch fresh data from Google Sheets API"
            ;;
        esac
        
        echo "CACHE_STATUS=$CACHE_STATUS" >> $GITHUB_ENV

    - name: Cache Puppeteer browsers
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/puppeteer
          ~/.local/share/puppeteer
          node_modules/puppeteer/.local-chromium
        key: ${{ runner.os }}-puppeteer-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-puppeteer-

    - name: Install dependencies
      run: |
        npm ci --prefer-offline --no-audit

    - name: Run crawler
      run: |
        echo "ğŸš€ Starting crawler for site: ${{ inputs.site }}"
        echo "ğŸ“Š Cache status: $CACHE_STATUS"
        
        if [ "$CACHE_STATUS" = "artifact" ] || [ "$CACHE_STATUS" = "existing" ]; then
          echo "ğŸ“ Using cached Google Sheets data"
        else
          echo "ğŸŒ Will fetch fresh data from Google Sheets API"
        fi
        
        node scripts/crawl-ecommerce-site.js

    - name: Upload results
      if: always()
      run: |
        echo "ğŸ“¤ Uploading results..."
        node node src/2_data/persistence/sheet/uploadToGoogleSheet.js